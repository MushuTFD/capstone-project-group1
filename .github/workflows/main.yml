name: 'DevSecOps CI/CD Pipeline (Terraform Cloud)'

on:
  push:
    branches:
      - main
      - dev-snky
  pull_request:

permissions:
  contents: read

jobs:
  terraform-validate-plan:
    name: 'Terraform-Validate-Plan'
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }} # Notice indentation!

    env:            
      AWS_REGION: ${{ github.ref == 'refs/heads/main' && 'ap-southeast-1' || 'ap-northeast-1' }}
  
    defaults: 
      run:
        shell: bash

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Clear Terraform Cache 
      run: rm -rf .terraform 

    - name: Install Snyk 
      run: npm install -g snyk

    - name: Print Environment 
      run: | 
        echo "AWS_REGION: $AWS_REGION"
        # Add other variables you use (AWS keys, etc.)

    - name: Terraform Init
      id: init
      env:
        AWS_BUCKET_NAME: ${{ secrets.AWS_BUCKET_NAME }}
        AWS_BUCKET_KEY_NAME: ${{ secrets.AWS_BUCKET_KEY_NAME }}
        AWS_REGION: ${{ github.ref == 'refs/heads/main' && 'ap-southeast-1' || 'ap-northeast-1' }}
      run: terraform init -backend-config="bucket=${AWS_BUCKET_NAME}" -backend-config="key=${AWS_BUCKET_KEY_NAME}" -backend-config="region=${AWS_REGION}"
      
    - name: Terraform fmt
      id: fmt
      run: terraform fmt -check
      continue-on-error: true

    - name: Terraform Validate
      id: validate
      run: terraform validate -no-color
      continue-on-error: true
      
    - name: Run Snyk auth
      id: auth
      run: snyk auth ${{ secrets.SNYK_TOKEN }}

    - name: Run Snyk dependency scan (pre-deployment)
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }} 
      run: snyk iac test --severity-threshold=high 